<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>True Vanilla - Recrutement Staff</title>
    <meta content="Recrutement staff True Vanilla" name="description">
    <link rel="icon" type="image/png" href="icons/favicon.png">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            --bg-dark: #0a0d12;
            --bg-card: #111827;
            --accent-aqua: #06b6d4;
            --accent-aqua-light: #22d3ee;
            --accent-aqua-glow: rgba(6, 182, 212, 0.3);
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-subtle: rgba(255, 255, 255, 0.08);
            --glass-bg: rgba(17, 24, 39, 0.9);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated Background */
        .bg-pattern {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
            background:
                radial-gradient(ellipse at 15% 30%, rgba(6, 182, 212, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse at 85% 70%, rgba(59, 130, 246, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 100%, rgba(6, 182, 212, 0.05) 0%, transparent 60%);
        }

        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--accent-aqua);
            border-radius: 50%;
            opacity: 0;
            animation: float-particle 10s infinite ease-in-out;
        }

        @keyframes float-particle {
            0%, 100% {
                transform: translateY(100vh) scale(0);
                opacity: 0;
            }
            10% {
                opacity: 0.5;
            }
            90% {
                opacity: 0.5;
            }
            100% {
                transform: translateY(-10vh) scale(1);
                opacity: 0;
            }
        }

        /* Main Content */
        main {
            position: relative;
            z-index: 1;
            padding: 2rem;
            max-width: 900px;
            margin: 0 auto;
        }

        /* Back Button */
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-family: 'Outfit', sans-serif;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-secondary);
            background: transparent;
            border: none;
            padding: 0.6rem 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
            text-decoration: none;
            margin-bottom: 2rem;
        }

        .back-btn:hover {
            color: var(--accent-aqua);
            background: rgba(6, 182, 212, 0.1);
        }

        /* Header Card */
        .header-card {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border-subtle);
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(ellipse at 50% 0%, rgba(6, 182, 212, 0.1) 0%, transparent 60%);
            pointer-events: none;
        }

        .header-card h1 {
            font-family: 'Cinzel', serif;
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 1rem;
            position: relative;
        }

        .header-card h1 span {
            color: var(--accent-aqua);
        }

        .header-card p {
            font-size: 1rem;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 1rem;
            position: relative;
        }

        .header-card .confidential {
            font-size: 0.8rem;
            color: var(--text-muted);
            line-height: 1.5;
            position: relative;
        }

        /* Chat Container */
        .chat-container {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border-subtle);
            padding: 1.5rem;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* Chat Messages */
        .chat-messages {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            flex: 1;
        }

        .message {
            display: flex;
            gap: 0.75rem;
            animation: fadeInUp 0.4s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.bot {
            justify-content: flex-start;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .message.bot .message-avatar {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.3), rgba(6, 182, 212, 0.1));
            border: 1px solid rgba(6, 182, 212, 0.3);
            overflow: hidden;
        }

        .message.bot .message-avatar i {
            color: var(--accent-aqua);
            font-size: 1.1rem;
        }

        .message.bot .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(139, 92, 246, 0.1));
            border: 1px solid rgba(139, 92, 246, 0.3);
            order: 2;
            overflow: hidden;
        }

        .message.user .message-avatar i {
            color: var(--accent-purple);
            font-size: 1.1rem;
        }

        .message.user .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
        }

        .message-content {
            max-width: 70%;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .message.user .message-content {
            align-items: flex-end;
        }

        .message-bubble {
            padding: 1rem 1.25rem;
            border-radius: 16px;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .message.bot .message-bubble {
            background: rgba(6, 182, 212, 0.1);
            border: 1px solid rgba(6, 182, 212, 0.2);
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
        }

        .message.user .message-bubble {
            background: rgba(139, 92, 246, 0.15);
            border: 1px solid rgba(139, 92, 246, 0.25);
            color: var(--text-primary);
            border-bottom-right-radius: 4px;
        }

        .message-small {
            font-size: 0.8rem;
            color: var(--text-muted);
            padding: 0 0.5rem;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 1rem 1.25rem;
            background: rgba(6, 182, 212, 0.1);
            border: 1px solid rgba(6, 182, 212, 0.2);
            border-radius: 16px;
            border-bottom-left-radius: 4px;
            width: fit-content;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--accent-aqua);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(1) { animation-delay: 0s; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.4;
            }
            30% {
                transform: translateY(-8px);
                opacity: 1;
            }
        }

        /* User Response Area */
        .response-area {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-subtle);
        }

        .response-buttons {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .response-btn {
            font-family: 'Outfit', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .response-btn.primary {
            background: linear-gradient(135deg, var(--accent-aqua), #0891b2);
            color: var(--bg-dark);
        }

        .response-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(6, 182, 212, 0.4);
        }

        .response-btn.secondary {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
            border: 1px solid var(--border-subtle);
        }

        .response-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .response-btn.discord {
            background: #5865F2;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .response-btn.discord:hover {
            background: #4752C4;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(88, 101, 242, 0.4);
        }

        .response-btn.discord.connected {
            background: rgba(88, 101, 242, 0.2);
            border: 1px solid rgba(88, 101, 242, 0.4);
            color: #5865F2;
        }

        /* Dropdown Selects */
        .date-selects {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .select-wrapper {
            position: relative;
        }

        .select-wrapper select {
            font-family: 'Outfit', sans-serif;
            font-size: 0.9rem;
            padding: 0.75rem 2.5rem 0.75rem 1rem;
            border-radius: 10px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-card);
            color: var(--text-primary);
            cursor: pointer;
            appearance: none;
            min-width: 100px;
        }

        .select-wrapper::after {
            content: '\f078';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
            font-size: 0.75rem;
        }

        .select-wrapper select:focus {
            outline: none;
            border-color: var(--accent-aqua);
        }

        /* Text Input */
        .text-input-wrapper {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            width: 100%;
        }

        .text-input {
            font-family: 'Outfit', sans-serif;
            font-size: 0.95rem;
            padding: 1rem;
            border-radius: 10px;
            border: 1px solid var(--border-subtle);
            background: rgba(0, 0, 0, 0.2);
            color: var(--text-primary);
            resize: vertical;
            min-height: 100px;
            transition: border-color 0.3s ease;
        }

        .text-input:focus {
            outline: none;
            border-color: var(--accent-aqua);
        }

        .text-input::placeholder {
            color: var(--text-muted);
        }

        .word-count {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-align: right;
        }

        .word-count.valid {
            color: var(--accent-aqua);
        }

        .word-count.invalid {
            color: #ef4444;
        }

        /* Final Button */
        .final-btn {
            display: block;
            width: 100%;
            font-family: 'Outfit', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            padding: 1.25rem 2rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            background: linear-gradient(135deg, var(--accent-aqua), #0891b2);
            color: var(--bg-dark);
            margin-top: 1rem;
        }

        .final-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(6, 182, 212, 0.4);
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: var(--accent-aqua); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #0891b2; }

        /* Responsive */
        @media (max-width: 768px) {
            main {
                padding: 1rem;
            }

            .header-card {
                padding: 1.5rem;
            }

            .header-card h1 {
                font-size: 1.4rem;
            }

            .message-content {
                max-width: 85%;
            }

            .response-buttons {
                justify-content: center;
            }

            .date-selects {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>
    <div class="particles" id="particles"></div>

    <main>
        <a href="index.html" class="back-btn">
            <i class="fas fa-arrow-left"></i>
            Retour √† l'accueil
        </a>

        <div class="header-card">
            <h1>Recrutement <span>Staff</span></h1>
            <p>Nous recrutons des membres du staff d√©vou√©s et s√©rieux pour rejoindre notre √©quipe.</p>
            <p class="confidential">Chaque information partag√©e durant ce questionnaire est enti√®rement confidentielle et sera uniquement visionn√©e par l'√©quipe du staff. Vos informations seront supprim√©es de nos bases de donn√©es apr√®s la conclusion de votre dossier.</p>
        </div>

        <div class="chat-container">
            <div class="chat-messages" id="chatMessages">
                <!-- Messages will be added here dynamically -->
            </div>

            <div class="response-area" id="responseArea">
                <!-- Response options will be added here dynamically -->
            </div>
        </div>
    </main>

    <script>
        // Discord OAuth Configuration - Replace with your actual values
        const DISCORD_CLIENT_ID = '1425143639125786724';
        const DISCORD_REDIRECT_URI = window.location.origin + window.location.pathname;
        const WEBHOOK_URL = 'https://discord.com/api/webhooks/1464331308804210947/_b1CJ1GpdVzj9wQKiTLnLMahJ-af1cxNwhiPJvWelZoQegE58AA9v5NNJAPei3LJmzvP';

        // Chat state
        let chatState = {
            step: 0,
            discordUser: null,
            birthDate: { day: null, month: null, year: null },
            server: null,
            hasExperience: null,
            experienceDetails: null,
            occupation: null,
            situation1: null,
            situation2: null,
            situation3: null
        };

        // Opening messages (random)
        const openingMessages = [
            "Si tu es l√†, c'est que le poste de Staff t'int√©resse ?",
            "Si tu lis ce message, c'est que tu envisages de rejoindre l'√©quipe, n'est-ce pas ?",
            "On dirait bien que quelqu'un a envie de mod√©rer par ici...",
            "Je crois comprendre que vous souhaitez postuler pour int√©grer notre √©quipe ?"
        ];

        // DOM Elements
        const chatMessages = document.getElementById('chatMessages');
        const responseArea = document.getElementById('responseArea');

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            createParticles();
            checkOAuthCallback();
            startChat();
        });

        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            for (let i = 0; i < 25; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 10 + 's';
                particle.style.animationDuration = (8 + Math.random() * 6) + 's';
                const size = 2 + Math.random() * 4;
                particle.style.width = size + 'px';
                particle.style.height = size + 'px';
                if (Math.random() > 0.6) particle.style.background = '#3b82f6';
                particlesContainer.appendChild(particle);
            }
        }

        function checkOAuthCallback() {
            const fragment = new URLSearchParams(window.location.hash.slice(1));
            const accessToken = fragment.get('access_token');
            
            if (accessToken) {
                // Clear the hash from URL
                history.replaceState(null, '', window.location.pathname);
                
                // Restore chat state from session storage
                const savedState = sessionStorage.getItem('chatState');
                if (savedState) {
                    chatState = JSON.parse(savedState);
                }
                
                // Fetch Discord user info
                fetchDiscordUser(accessToken);
            }
        }

        async function fetchDiscordUser(accessToken) {
            try {
                const response = await fetch('https://discord.com/api/users/@me', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                const user = await response.json();
                chatState.discordUser = {
                    id: user.id,
                    username: user.username,
                    discriminator: user.discriminator,
                    avatar: user.avatar,
                    globalName: user.global_name || user.username
                };
                
                // Continue chat from where we left off
                restoreChat();
            } catch (error) {
                console.error('Error fetching Discord user:', error);
                addBotMessage("Une erreur est survenue lors de la connexion Discord. Veuillez r√©essayer.");
                showDiscordButton();
            }
        }

        function restoreChat() {
            // Restore messages and continue
            const randomMessage = openingMessages[Math.floor(Math.random() * openingMessages.length)];
            addBotMessageInstant(randomMessage);
            addUserMessageInstant("Oui");
            addBotMessageInstant("Parfait ! Pour commencer, j'aimerais savoir √† qui je parle. Connecte-toi avec ton compte Discord pour que je puisse t'identifier.");
            
            // Show connected state
            addUserMessageInstant(`Connect√© en tant que ${chatState.discordUser.globalName}`);
            
            chatState.step = 2;
            proceedToStep(2);
        }

        function startChat() {
            if (chatState.discordUser) return; // Already restored
            
            chatState.step = 0;
            const randomMessage = openingMessages[Math.floor(Math.random() * openingMessages.length)];
            showTypingThenMessage(randomMessage, () => {
                showYesNoButtons();
            });
        }

        function showTypingThenMessage(message, callback, smallText = null) {
            // Show typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot';
            typingDiv.innerHTML = `
                <div class="message-avatar"><img src="icons/favicon.png" alt="Bot"></div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
            scrollToBottom();

            // Wait, then show message with typewriter effect
            setTimeout(() => {
                typingDiv.remove();
                addBotMessageWithTypewriter(message, callback, smallText);
            }, 1000 + Math.random() * 500);
        }

        function addBotMessageWithTypewriter(message, callback, smallText = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';
            messageDiv.innerHTML = `
                <div class="message-avatar"><img src="icons/favicon.png" alt="Bot"></div>
                <div class="message-content">
                    <div class="message-bubble"><span class="typewriter-text"></span></div>
                    ${smallText ? `<div class="message-small hidden">${smallText}</div>` : ''}
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();

            const textSpan = messageDiv.querySelector('.typewriter-text');
            const smallTextDiv = messageDiv.querySelector('.message-small');
            let i = 0;

            function type() {
                if (i < message.length) {
                    textSpan.textContent += message.charAt(i);
                    i++;
                    scrollToBottom();
                    setTimeout(type, 20 + Math.random() * 20);
                } else {
                    if (smallTextDiv) {
                        smallTextDiv.classList.remove('hidden');
                    }
                    if (callback) callback();
                }
            }
            type();
        }

        function addBotMessage(message, smallText = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';
            messageDiv.innerHTML = `
                <div class="message-avatar"><img src="icons/favicon.png" alt="Bot"></div>
                <div class="message-content">
                    <div class="message-bubble">${message}</div>
                    ${smallText ? `<div class="message-small">${smallText}</div>` : ''}
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function addBotMessageInstant(message, smallText = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';
            messageDiv.style.animation = 'none';
            messageDiv.innerHTML = `
                <div class="message-avatar"><img src="icons/favicon.png" alt="Bot"></div>
                <div class="message-content">
                    <div class="message-bubble">${message}</div>
                    ${smallText ? `<div class="message-small">${smallText}</div>` : ''}
                </div>
            `;
            chatMessages.appendChild(messageDiv);
        }

        function addUserMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            const avatarContent = getUserAvatarContent();
            messageDiv.innerHTML = `
                <div class="message-content">
                    <div class="message-bubble">${message}</div>
                </div>
                <div class="message-avatar">${avatarContent}</div>
            `;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function addUserMessageInstant(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            messageDiv.style.animation = 'none';
            const avatarContent = getUserAvatarContent();
            messageDiv.innerHTML = `
                <div class="message-content">
                    <div class="message-bubble">${message}</div>
                </div>
                <div class="message-avatar">${avatarContent}</div>
            `;
            chatMessages.appendChild(messageDiv);
        }

        function getUserAvatarContent() {
            if (chatState.discordUser && chatState.discordUser.avatar) {
                const avatarUrl = `https://cdn.discordapp.com/avatars/${chatState.discordUser.id}/${chatState.discordUser.avatar}.png?size=80`;
                return `<img src="${avatarUrl}" alt="${chatState.discordUser.globalName}">`;
            } else if (chatState.discordUser) {
                // Default Discord avatar
                const defaultAvatar = parseInt(chatState.discordUser.id) % 5;
                const avatarUrl = `https://cdn.discordapp.com/embed/avatars/${defaultAvatar}.png`;
                return `<img src="${avatarUrl}" alt="${chatState.discordUser.globalName}">`;
            }
            return '<i class="fa-solid fa-user"></i>';
        }

        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
            window.scrollTo({
                top: document.body.scrollHeight,
                behavior: 'smooth'
            });
        }

        function clearResponseArea() {
            responseArea.innerHTML = '';
        }

        // Step handlers
        function showYesNoButtons() {
            clearResponseArea();
            responseArea.innerHTML = `
                <div class="response-buttons">
                    <button class="response-btn secondary" onclick="handleNo()">Non</button>
                    <button class="response-btn primary" onclick="handleYes()">Oui</button>
                </div>
            `;
        }

        function handleNo() {
            addUserMessage("Non");
            clearResponseArea();
            window.location.href = 'index.html';
        }

        function handleYes() {
            addUserMessage("Oui");
            clearResponseArea();
            chatState.step = 1;
            showTypingThenMessage("Parfait ! Pour commencer, j'aimerais savoir √† qui je parle. Connecte-toi avec ton compte Discord pour que je puisse t'identifier.", () => {
                showDiscordButton();
            });
        }

        function showDiscordButton() {
            clearResponseArea();
            if (chatState.discordUser) {
                responseArea.innerHTML = `
                    <div class="response-buttons">
                        <button class="response-btn discord connected">
                            <i class="fab fa-discord"></i>
                            ${chatState.discordUser.globalName}
                        </button>
                    </div>
                `;
            } else {
                responseArea.innerHTML = `
                    <div class="response-buttons">
                        <button class="response-btn discord" onclick="connectDiscord()">
                            <i class="fab fa-discord"></i>
                            Se connecter avec Discord
                        </button>
                    </div>
                `;
            }
        }

        function connectDiscord() {
            // Save current state before redirect
            sessionStorage.setItem('chatState', JSON.stringify(chatState));
            
            const scope = 'identify';
            const authUrl = `https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${encodeURIComponent(DISCORD_REDIRECT_URI)}&response_type=token&scope=${scope}`;
            
            // Open in popup
            const width = 500;
            const height = 700;
            const left = (window.innerWidth - width) / 2;
            const top = (window.innerHeight - height) / 2;
            
            const popup = window.open(authUrl, 'Discord Login', `width=${width},height=${height},left=${left},top=${top}`);
            
            // Check for popup close and token
            const checkPopup = setInterval(() => {
                try {
                    if (popup.closed) {
                        clearInterval(checkPopup);
                        return;
                    }
                    
                    if (popup.location.hash) {
                        const fragment = new URLSearchParams(popup.location.hash.slice(1));
                        const accessToken = fragment.get('access_token');
                        
                        if (accessToken) {
                            clearInterval(checkPopup);
                            popup.close();
                            fetchDiscordUserFromPopup(accessToken);
                        }
                    }
                } catch (e) {
                    // Cross-origin error, popup is on Discord's domain
                }
            }, 500);
        }

        async function fetchDiscordUserFromPopup(accessToken) {
            try {
                const response = await fetch('https://discord.com/api/users/@me', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                const user = await response.json();
                chatState.discordUser = {
                    id: user.id,
                    username: user.username,
                    discriminator: user.discriminator,
                    avatar: user.avatar,
                    globalName: user.global_name || user.username
                };
                
                // Update button and continue
                addUserMessage(`Connect√© en tant que ${chatState.discordUser.globalName}`);
                chatState.step = 2;
                proceedToStep(2);
            } catch (error) {
                console.error('Error fetching Discord user:', error);
                addBotMessage("Une erreur est survenue lors de la connexion Discord. Veuillez r√©essayer.");
                showDiscordButton();
            }
        }

        function proceedToStep(step) {
            clearResponseArea();
            
            switch(step) {
                case 2: // Ask for age
                    showTypingThenMessage(
                        `Je vois, tu t'appelles donc ${chatState.discordUser.globalName}, et derni√®re chose personnelle : tu as quel √¢ge ?`,
                        showDateSelects,
                        "Votre √¢ge aura peu d'impact sur votre candidature, on ne se base pas uniquement sur √ßa"
                    );
                    break;
                    
                case 3: // Ask for server preference
                    showTypingThenMessage(
                        "Merci beaucoup de m'avoir partag√© ces informations. Maintenant, passons aux choses s√©rieuses. Pour commencer, sur quel serveur pr√©f√©rerais-tu mod√©rer ?",
                        showServerButtons
                    );
                    break;
                    
                case 4: // Ask for experience
                    showTypingThenMessage(
                        "As-tu de l'exp√©rience dans la mod√©ration de serveurs de jeu ? (Minecraft, ou autre jeux)",
                        showExperienceButtons
                    );
                    break;
                    
                case 5: // Ask for occupation
                    const experienceResponse = chatState.hasExperience 
                        ? "Int√©ressant, je vois que tu t'y connais un peu dans le domaine. Pour conna√Ætre tes disponibilit√©s, as-tu un travail ou es-tu √©tudiant ?"
                        : "D'accord, alors √ßa sera l'occasion d'apprendre ! Pour conna√Ætre tes disponibilit√©s, as-tu un travail ou es-tu √©tudiant ?";
                    showTypingThenMessage(experienceResponse, showOccupationButtons);
                    break;
                    
                case 6: // First situation
                    showTypingThenMessage(
                        "C'est not√©. Pour les disponibilit√©s, on en reparlera lors d'un entretien vocal. Pour l'instant, je vais te proposer quelques mises en situation pour voir comment tu r√©agirais en pratique.",
                        () => {
                            setTimeout(() => {
                                showTypingThenMessage(
                                    "Commen√ßons par une mise en situation : tu n'es pas connect√©, mais tu re√ßois 5 ou 6 plaintes signalant un joueur pour toxicit√©. Tu d√©cides de te connecter pour intervenir, mais face √† toi, le joueur se montre tr√®s chaleureux et sympathique. Comment g√®res-tu cette situation ?",
                                    () => showTextInput(15, 'situation1')
                                );
                            }, 500);
                        }
                    );
                    break;
                    
                case 7: // Second situation
                    showTypingThenMessage(
                        "Situation suivante : Tu es en spec et tu suis un mineur. C'est flagrant : il fonce direct sur les diamants comme s'il voyait √† travers les murs. Tu le freezes pour le confronter. Le joueur te rejoint en vocal, mais malgr√© les preuves √©videntes de son trac√©, il nie tout et jure qu'il ne cheat pas. Comment g√®res-tu ce d√©ni ?",
                        () => showTextInput(15, 'situation2')
                    );
                    break;
                    
                case 8: // Third situation
                    showTypingThenMessage(
                        "Derni√®re situation : Un joueur ouvre un ticket pour signaler un bug de duplication. Le probl√®me, c'est qu'en v√©rifiant son Ender Chest, tu d√©couvres une quantit√© √©norme de Netherite qui a manifestement √©t√© dupliqu√©e. Il signale le bug, mais il en a profit√© avant. Que fais-tu ?",
                        () => showTextInput(15, 'situation3')
                    );
                    break;
                    
                case 9: // Final message
                    showTypingThenMessage(
                        "Parfait ! Je transmets ton dossier √† l'√©quipe du staff d√®s maintenant. Tu recevras une r√©ponse en message priv√© (MP) pour t'informer de la suite. Merci pour ta candidature et √† bient√¥t !",
                        () => {
                            sendToWebhook();
                            showFinalButton();
                        }
                    );
                    break;
            }
        }

        function showDateSelects() {
            clearResponseArea();
            
            // Generate day options
            let dayOptions = '<option value="">Jour</option>';
            for (let i = 1; i <= 31; i++) {
                dayOptions += `<option value="${i}">${i}</option>`;
            }
            
            // Generate month options
            const months = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
            let monthOptions = '<option value="">Mois</option>';
            months.forEach((month, i) => {
                monthOptions += `<option value="${i + 1}">${month}</option>`;
            });
            
            // Generate year options (from current year - 60 to current year - 13)
            const currentYear = new Date().getFullYear();
            let yearOptions = '<option value="">Ann√©e</option>';
            for (let i = currentYear - 13; i >= currentYear - 60; i--) {
                yearOptions += `<option value="${i}">${i}</option>`;
            }
            
            responseArea.innerHTML = `
                <div class="date-selects">
                    <div class="select-wrapper">
                        <select id="daySelect" onchange="checkDateComplete()">
                            ${dayOptions}
                        </select>
                    </div>
                    <div class="select-wrapper">
                        <select id="monthSelect" onchange="checkDateComplete()">
                            ${monthOptions}
                        </select>
                    </div>
                    <div class="select-wrapper">
                        <select id="yearSelect" onchange="checkDateComplete()">
                            ${yearOptions}
                        </select>
                    </div>
                    <button class="response-btn primary hidden" id="dateConfirmBtn" onclick="confirmDate()">Confirmer</button>
                </div>
            `;
        }

        function checkDateComplete() {
            const day = document.getElementById('daySelect').value;
            const month = document.getElementById('monthSelect').value;
            const year = document.getElementById('yearSelect').value;
            const confirmBtn = document.getElementById('dateConfirmBtn');
            
            if (day && month && year) {
                confirmBtn.classList.remove('hidden');
            } else {
                confirmBtn.classList.add('hidden');
            }
        }

        function confirmDate() {
            const day = parseInt(document.getElementById('daySelect').value);
            const month = parseInt(document.getElementById('monthSelect').value);
            const year = parseInt(document.getElementById('yearSelect').value);
            
            chatState.birthDate = { day, month, year };
            
            // Calculate age
            const today = new Date();
            const birthDate = new Date(year, month - 1, day);
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            chatState.age = age;
            
            addUserMessage(`${day}/${month}/${year} (${age} ans)`);
            chatState.step = 3;
            proceedToStep(3);
        }

        function showServerButtons() {
            clearResponseArea();
            responseArea.innerHTML = `
                <div class="response-buttons">
                    <button class="response-btn secondary" onclick="selectServer('Mini-jeux')">Mini-jeux</button>
                    <button class="response-btn secondary" onclick="selectServer('SMP')">SMP</button>
                    <button class="response-btn secondary" onclick="selectServer('Whitelist')">Whitelist</button>
                    <button class="response-btn secondary" onclick="selectServer('Pas de pr√©f√©rence particuli√®re')">Pas de pr√©f√©rence particuli√®re.</button>
                </div>
            `;
        }

        function selectServer(server) {
            chatState.server = server;
            addUserMessage(server);
            chatState.step = 4;
            proceedToStep(4);
        }

        function showExperienceButtons() {
            clearResponseArea();
            responseArea.innerHTML = `
                <div class="response-buttons">
                    <button class="response-btn secondary" onclick="selectExperience(false)">Non</button>
                    <button class="response-btn primary" onclick="selectExperience(true)">Oui</button>
                </div>
            `;
        }

        function selectExperience(hasExperience) {
            chatState.hasExperience = hasExperience;
            addUserMessage(hasExperience ? "Oui" : "Non");
            
            if (hasExperience) {
                showExperienceTextInput();
            } else {
                clearResponseArea();
                responseArea.innerHTML = `
                    <div class="response-buttons">
                        <button class="response-btn primary" onclick="confirmNoExperience()">Confirmer</button>
                    </div>
                `;
            }
        }

        function showExperienceTextInput() {
            clearResponseArea();
            responseArea.innerHTML = `
                <div class="text-input-wrapper">
                    <textarea class="text-input" id="experienceInput" placeholder="Quel jeu, quel serveur, combien de temps..." oninput="checkExperienceWords()"></textarea>
                    <div class="word-count" id="experienceWordCount">0/10 mots minimum</div>
                    <button class="response-btn primary hidden" id="experienceConfirmBtn" onclick="confirmExperience()">Confirmer</button>
                </div>
            `;
        }

        function checkExperienceWords() {
            const input = document.getElementById('experienceInput');
            const wordCount = document.getElementById('experienceWordCount');
            const confirmBtn = document.getElementById('experienceConfirmBtn');
            
            const words = input.value.trim().split(/\s+/).filter(w => w.length > 0);
            const count = words.length;
            
            wordCount.textContent = `${count}/10 mots minimum`;
            
            if (count >= 10) {
                wordCount.classList.add('valid');
                wordCount.classList.remove('invalid');
                confirmBtn.classList.remove('hidden');
            } else {
                wordCount.classList.remove('valid');
                wordCount.classList.add('invalid');
                confirmBtn.classList.add('hidden');
            }
        }

        function confirmExperience() {
            const input = document.getElementById('experienceInput').value.trim();
            chatState.experienceDetails = input;
            addUserMessage(input);
            chatState.step = 5;
            proceedToStep(5);
        }

        function confirmNoExperience() {
            chatState.step = 5;
            proceedToStep(5);
        }

        function showOccupationButtons() {
            clearResponseArea();
            responseArea.innerHTML = `
                <div class="response-buttons">
                    <button class="response-btn secondary" onclick="selectOccupation('Travail')">Travail</button>
                    <button class="response-btn secondary" onclick="selectOccupation('√âtudiant')">√âtudiant</button>
                </div>
            `;
        }

        function selectOccupation(occupation) {
            chatState.occupation = occupation;
            addUserMessage(occupation);
            chatState.step = 6;
            proceedToStep(6);
        }

        function showTextInput(minWords, fieldName) {
            clearResponseArea();
            responseArea.innerHTML = `
                <div class="text-input-wrapper">
                    <textarea class="text-input" id="situationInput" placeholder="√âcrivez votre r√©ponse ici..." oninput="checkSituationWords(${minWords})"></textarea>
                    <div class="word-count" id="situationWordCount">0/${minWords} mots minimum</div>
                    <button class="response-btn primary hidden" id="situationConfirmBtn" onclick="confirmSituation('${fieldName}')">Confirmer</button>
                </div>
            `;
        }

        function checkSituationWords(minWords) {
            const input = document.getElementById('situationInput');
            const wordCount = document.getElementById('situationWordCount');
            const confirmBtn = document.getElementById('situationConfirmBtn');
            
            const words = input.value.trim().split(/\s+/).filter(w => w.length > 0);
            const count = words.length;
            
            wordCount.textContent = `${count}/${minWords} mots minimum`;
            
            if (count >= minWords) {
                wordCount.classList.add('valid');
                wordCount.classList.remove('invalid');
                confirmBtn.classList.remove('hidden');
            } else {
                wordCount.classList.remove('valid');
                wordCount.classList.add('invalid');
                confirmBtn.classList.add('hidden');
            }
        }

        function confirmSituation(fieldName) {
            const input = document.getElementById('situationInput').value.trim();
            chatState[fieldName] = input;
            addUserMessage(input);
            
            if (fieldName === 'situation1') {
                chatState.step = 7;
                proceedToStep(7);
            } else if (fieldName === 'situation2') {
                chatState.step = 8;
                proceedToStep(8);
            } else if (fieldName === 'situation3') {
                chatState.step = 9;
                proceedToStep(9);
            }
        }

        async function sendToWebhook() {
            const embed = {
                title: "üìã Nouvelle Candidature Staff",
                color: 0x06b6d4,
                fields: [
                    {
                        name: "üë§ Candidat",
                        value: `${chatState.discordUser.globalName} (<@${chatState.discordUser.id}>)`,
                        inline: true
                    },
                    {
                        name: "üéÇ √Çge",
                        value: `${chatState.age} ans`,
                        inline: true
                    },
                    {
                        name: "üíº Occupation",
                        value: chatState.occupation,
                        inline: true
                    },
                    {
                        name: "üéÆ Serveur pr√©f√©r√©",
                        value: chatState.server,
                        inline: true
                    },
                    {
                        name: "üìú Exp√©rience mod√©ration",
                        value: chatState.hasExperience ? "Oui" : "Non",
                        inline: true
                    }
                ],
                timestamp: new Date().toISOString()
            };

            if (chatState.hasExperience && chatState.experienceDetails) {
                embed.fields.push({
                    name: "üìù D√©tails exp√©rience",
                    value: chatState.experienceDetails.substring(0, 1024),
                    inline: false
                });
            }

            embed.fields.push(
                {
                    name: "üîç Situation 1 - Joueur toxique",
                    value: chatState.situation1.substring(0, 1024),
                    inline: false
                },
                {
                    name: "üîç Situation 2 - Suspicion de cheat",
                    value: chatState.situation2.substring(0, 1024),
                    inline: false
                },
                {
                    name: "üîç Situation 3 - Bug de duplication",
                    value: chatState.situation3.substring(0, 1024),
                    inline: false
                }
            );

            try {
                await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        embeds: [embed]
                    })
                });
            } catch (error) {
                console.error('Error sending to webhook:', error);
            }
        }

        function showFinalButton() {
            clearResponseArea();
            responseArea.innerHTML = `
                <button class="final-btn" onclick="window.location.href='index.html'">
                    <i class="fas fa-home"></i> Retour √† l'accueil
                </button>
            `;
        }
    </script>
</body>
</html>
